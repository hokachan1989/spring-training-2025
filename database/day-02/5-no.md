---
description: データを取得したら、より見やすく、扱いやすくするために結果を整形することがよくあります。この章では、検索結果の整形や加工の方法について学びます。
---

# 5. 検索結果の加工

### 5.1 結果の整形

#### 5.1.1 別名（エイリアス）の使用

`AS`キーワードを使用して、結果の列名に別名（エイリアス）を付けることができます：

```sql
-- カラムに日本語の別名を付ける
SELECT 
    name AS 商品名,
    price AS 価格,
    stock AS 在庫数
FROM products;
```

実行結果:

```
+--------------------+----------+--------+
| 商品名             | 価格     | 在庫数 |
+--------------------+----------+--------+
| スマートフォン     | 89000.00 |     25 |
| ラップトップPC     |120000.00 |     15 |
| コーヒーメーカー   | 15000.00 |     30 |
+--------------------+----------+--------+
3 rows in set (0.00 sec)
```

> 📝 **ポイント**: `AS`キーワードは省略可能です。例: `name 商品名`

テーブルにも別名を付けることができます。これは特に複数のテーブルを扱う場合に便利です：

```sql
-- テーブルに別名をつける
SELECT 
    p.name AS 商品名,
    p.price AS 価格,
    c.name AS カテゴリ
FROM 
    products AS p,
    categories AS c
WHERE 
    p.category_id = c.id;
```

#### 5.1.2 重複行の排除（DISTINCT）

重複する行を排除したい場合は、`DISTINCT`キーワードを使用します：

```sql
-- カテゴリIDの一覧（重複なし）を取得
SELECT DISTINCT category_id FROM products;
```

実行結果:

```
+-------------+
| category_id |
+-------------+
|           1 |
|           2 |
|           3 |
+-------------+
3 rows in set (0.00 sec)
```

複数の列を指定した場合、それらの列の組み合わせの重複が排除されます：

```sql
-- カテゴリID+在庫状態（0か0以外か）の組み合わせの一覧
SELECT DISTINCT category_id, stock > 0 AS has_stock
FROM products;
```

実行結果:

```
+-------------+----------+
| category_id | has_stock |
+-------------+----------+
|           1 |        1 |
|           2 |        1 |
|           3 |        1 |
|           1 |        0 |
+-------------+----------+
4 rows in set (0.00 sec)
```

#### 5.1.3 結果の並べ替え（ORDER BY）

`ORDER BY`句を使用すると、特定の列の値に基づいて結果を並べ替えることができます：

```sql
-- 価格の安い順に商品を表示
SELECT name, price
FROM products
ORDER BY price;
```

実行結果:

```
+----------------------+----------+
| name                 | price    |
+----------------------+----------+
| マウス               |  2000.00 |
| キーボード           |  6000.00 |
| コーヒーメーカー     | 15000.00 |
| スマートフォン       | 89000.00 |
| ラップトップPC       |120000.00 |
+----------------------+----------+
5 rows in set (0.00 sec)
```

降順（大きい順）に並べ替えるには、`DESC`キーワードを使います：

```sql
-- 価格の高い順に商品を表示
SELECT name, price
FROM products
ORDER BY price DESC;
```

実行結果:

```
+----------------------+----------+
| name                 | price    |
+----------------------+----------+
| ラップトップPC       |120000.00 |
| スマートフォン       | 89000.00 |
| コーヒーメーカー     | 15000.00 |
| キーボード           |  6000.00 |
| マウス               |  2000.00 |
+----------------------+----------+
5 rows in set (0.00 sec)
```

複数の列で並べ替えることもできます：

```sql
-- カテゴリID順、同じカテゴリ内では価格の高い順
SELECT name, category_id, price
FROM products
ORDER BY category_id, price DESC;
```

実行結果:

```
+----------------------+-------------+----------+
| name                 | category_id | price    |
+----------------------+-------------+----------+
| ラップトップPC       |           1 |120000.00 |
| スマートフォン       |           1 | 89000.00 |
| キーボード           |           1 |  6000.00 |
| マウス               |           1 |  2000.00 |
| コーヒーメーカー     |           2 | 15000.00 |
| プログラミング本     |           3 |  3500.00 |
+----------------------+-------------+----------+
6 rows in set (0.00 sec)
```

> 📝 **ポイント**: デフォルトでは昇順（ASC）になります。明示的に指定することもできますが、通常は省略します。

#### 5.1.4 結果の制限（LIMIT）

`LIMIT`句を使うと、返される行数を制限できます：

```sql
-- 価格の高い上位3つの商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3;
```

実行結果:

```
+----------------------+----------+
| name                 | price    |
+----------------------+----------+
| ラップトップPC       |120000.00 |
| スマートフォン       | 89000.00 |
| コーヒーメーカー     | 15000.00 |
+----------------------+----------+
3 rows in set (0.00 sec)
```

特定の位置から始めて数行を取得するには、`OFFSET`を使用します：

```sql
-- 価格の高い順で4番目と5番目の商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 2 OFFSET 3;
```

実行結果:

```
+-------------+--------+
| name        | price  |
+-------------+--------+
| キーボード  | 6000.00|
| マウス      | 2000.00|
+-------------+--------+
2 rows in set (0.00 sec)
```

> 📝 **ポイント**: `LIMIT`は省略形で`LIMIT [OFFSET,] row_count`という形式も使えます。例: `LIMIT 3, 2`は`LIMIT 2 OFFSET 3`と同じです。

### 5.2 計算フィールドと関数

#### 5.2.1 計算フィールド

SELECTクエリー内で計算を実行できます：

```sql
-- 商品の合計金額（価格×在庫数）
SELECT 
    name, 
    price, 
    stock, 
    price * stock AS 合計金額
FROM products;
```

実行結果:

```
+--------------------+----------+-------+------------+
| name               | price    | stock | 合計金額   |
+--------------------+----------+-------+------------+
| スマートフォン     | 89000.00 |    25 | 2225000.00 |
| ラップトップPC     |120000.00 |    15 | 1800000.00 |
| コーヒーメーカー   | 15000.00 |    30 |  450000.00 |
| キーボード         |  6000.00 |    20 |  120000.00 |
| マウス             |  2000.00 |    30 |   60000.00 |
+--------------------+----------+-------+------------+
5 rows in set (0.00 sec)
```

```sql
-- 税込価格（10%）
SELECT 
    name, 
    price AS 税抜価格, 
    price * 1.1 AS 税込価格
FROM products;
```

実行結果:

```
+--------------------+----------+------------+
| name               | 税抜価格 | 税込価格   |
+--------------------+----------+------------+
| スマートフォン     | 89000.00 |   97900.00 |
| ラップトップPC     |120000.00 |  132000.00 |
| コーヒーメーカー   | 15000.00 |   16500.00 |
| キーボード         |  6000.00 |    6600.00 |
| マウス             |  2000.00 |    2200.00 |
+--------------------+----------+------------+
5 rows in set (0.00 sec)
```

#### 5.2.2 文字列関数

文字列を操作するための関数が多数用意されています：

```sql
-- 文字列の結合
SELECT CONCAT(name, '（', FORMAT(price, 0), '円）') AS 商品情報
FROM products;
```

実行結果:

```
+------------------------------+
| 商品情報                     |
+------------------------------+
| スマートフォン（89,000円）   |
| ラップトップPC（120,000円）  |
| コーヒーメーカー（15,000円） |
| キーボード（6,000円）        |
| マウス（2,000円）            |
+------------------------------+
5 rows in set (0.00 sec)
```

よく使う文字列関数：

* `LENGTH(str)`: 文字列の長さを返します
* `UPPER(str)`: 文字列を大文字に変換します
* `LOWER(str)`: 文字列を小文字に変換します
* `SUBSTRING(str, pos, len)`: 部分文字列を取得します
* `TRIM(str)`: 文字列の先頭と末尾の空白を削除します

#### 5.2.3 数値関数

数値を操作するための関数もあります：

```sql
-- 四捨五入とフォーマット
SELECT
    name,
    price,
    ROUND(price, -3) AS 千円単位に丸める,
    FORMAT(price, 0) AS カンマ区切り
FROM products;
```

実行結果:

```
+--------------------+----------+------------------+----------------+
| name               | price    | 千円単位に丸める | カンマ区切り   |
+--------------------+----------+------------------+----------------+
| スマートフォン     | 89000.00 |          89000.00| 89,000         |
| ラップトップPC     |120000.00 |         120000.00| 120,000        |
| コーヒーメーカー   | 15000.00 |          15000.00| 15,000         |
| キーボード         |  6000.00 |           6000.00| 6,000          |
| マウス             |  2000.00 |           2000.00| 2,000          |
+--------------------+----------+------------------+----------------+
5 rows in set (0.00 sec)
```

#### 5.2.4 条件関数（CASE式）

`CASE`式を使うと、条件に基づいて異なる値を返すことができます：

```sql
-- 価格帯による分類
SELECT 
    name, 
    price,
    CASE 
        WHEN price < 5000 THEN '低価格'
        WHEN price < 50000 THEN '中価格'
        ELSE '高価格'
    END AS 価格帯
FROM products;
```

実行結果:

```
+--------------------+----------+----------+
| name               | price    | 価格帯   |
+--------------------+----------+----------+
| スマートフォン     | 89000.00 | 高価格   |
| ラップトップPC     |120000.00 | 高価格   |
| コーヒーメーカー   | 15000.00 | 中価格   |
| キーボード         |  6000.00 | 中価格   |
| マウス             |  2000.00 | 低価格   |
+--------------------+----------+----------+
5 rows in set (0.00 sec)
```

```sql
-- 在庫状況の表示
SELECT 
    name, 
    stock,
    CASE 
        WHEN stock = 0 THEN '在庫切れ'
        WHEN stock < 10 THEN '残りわずか'
        ELSE '在庫あり'
    END AS 在庫状況
FROM products;
```

実行結果:

```
+--------------------+-------+------------+
| name               | stock | 在庫状況   |
+--------------------+-------+------------+
| スマートフォン     |    25 | 在庫あり   |
| ラップトップPC     |    15 | 在庫あり   |
| コーヒーメーカー   |    30 | 在庫あり   |
| キーボード         |    20 | 在庫あり   |
| マウス             |    30 | 在庫あり   |
| 特売商品           |     0 | 在庫切れ   |
| 限定モデル         |     5 | 残りわずか |
+--------------------+-------+------------+
7 rows in set (0.00 sec)
```

> 📝 **ポイント**: CASE式は `SELECT` 句だけでなく、`WHERE` 句や `ORDER BY` 句でも使用できます。

### 5.3 NULL値の処理

#### 5.3.1 IFNULL関数

NULL値を別の値に置き換えるには、`IFNULL`関数を使用します：

```sql
-- 説明がNULLの場合は「詳細情報なし」と表示
SELECT 
    name, 
    IFNULL(description, '詳細情報なし') AS 説明
FROM products;
```

実行結果:

```
+--------------------+----------------------+
| name               | 説明                 |
+--------------------+----------------------+
| スマートフォン     | 最新型スマホ         |
| ラップトップPC     | 高性能ノートPC       |
| コーヒーメーカー   | 全自動コーヒーマシン |
| キーボード         | 詳細情報なし         |
| マウス             | 詳細情報なし         |
+--------------------+----------------------+
5 rows in set (0.00 sec)
```

***

### 演習問題

#### 問題 5-1: 別名（エイリアス）の使用

商品情報を見やすく表示するために、以下のクエリーを作成してください：

1. 商品の名前、価格、在庫数をそれぞれ「商品名」「価格」「在庫数」という列名で表示する
2. カテゴリ情報も含め、列名を日本語にして表示する

**ヒント:**

* 列名を変更するには `AS` キーワードを使います（例: `name AS 商品名`）
* テーブルに別名をつけると便利です（例: `products AS p`）

\<details> \<summary>解答\</summary>

```sql
-- 1. 商品情報を日本語列名で表示
SELECT
    name AS 商品名,
    price AS 価格,
    stock AS 在庫数
FROM products;

-- 2. カテゴリ情報を含めて表示
SELECT
    p.name AS 商品名,
    p.price AS 価格,
    p.stock AS 在庫数,
    c.name AS カテゴリ
FROM
    products AS p,
    categories AS c
WHERE
    p.category_id = c.id;
```

\</details>

#### 問題 5-2: 重複行の排除（DISTINCT）

1. 商品テーブルにある異なるカテゴリIDのリストを表示する
2. 商品テーブルの中で、価格帯（1万円未満、1万円以上5万円未満、5万円以上）ごとに何種類のカテゴリがあるか調べる

**ヒント:**

* 重複を排除するには `DISTINCT` キーワードを使います
* 価格帯は `CASE` 式で分類し、それを `DISTINCT` と組み合わせます

\<details> \<summary>解答\</summary>

```sql
-- 1. 異なるカテゴリIDのリスト
SELECT DISTINCT category_id
FROM products;

-- 2. 価格帯ごとのカテゴリの種類
SELECT DISTINCT
    CASE
        WHEN price < 10000 THEN '1万円未満'
        WHEN price < 50000 THEN '1万円以上5万円未満'
        ELSE '5万円以上'
    END AS 価格帯,
    category_id
FROM products
ORDER BY 価格帯, category_id;
```

\</details>

#### 問題 5-3: 結果の並べ替え（ORDER BY）

以下のクエリーを作成してください：

1. 商品を価格の高い順に並べ替えて表示する
2. カテゴリごとに商品を分け、各カテゴリ内で価格の安い順に並べる
3. 在庫数が多い順に並べ、同じ在庫数の場合は価格の高い順に並べる

**ヒント:**

* 並べ替えには `ORDER BY` 句を使います
* 降順にするには `DESC` を、昇順にするには `ASC`（省略可能）を使います
* 複数の列で並べ替える場合は、カンマで区切ります

\<details> \<summary>解答\</summary>

```sql
-- 1. 価格の高い順
SELECT name, price
FROM products
ORDER BY price DESC;

-- 2. カテゴリごと、価格の安い順
SELECT 
    c.name AS カテゴリ,
    p.name AS 商品名,
    p.price AS 価格
FROM 
    products AS p,
    categories AS c
WHERE
    p.category_id = c.id
ORDER BY
    c.name, p.price;

-- 3. 在庫数が多い順、同じなら価格の高い順
SELECT name, stock, price
FROM products
ORDER BY stock DESC, price DESC;
```

\</details>

#### 問題 5-4: 結果の制限（LIMIT）

以下のクエリーを作成してください：

1. 価格の高い上位3つの商品を表示する
2. 4番目から6番目に価格の高い商品を表示する

**ヒント:**

* 結果の行数を制限するには `LIMIT` を使います
* 特定の位置からデータを取得するには `LIMIT` と `OFFSET` を組み合わせます

\<details> \<summary>解答\</summary>

```sql
-- 1. 価格の高い上位3つの商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3;

-- 2. 4番目から6番目に価格の高い商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3 OFFSET 3;
-- または
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3, 3;
```

\</details>

#### 問題 5-5: 計算フィールドの使用

以下のクエリーを作成してください：

1. 各商品の税込価格（10%）と税額を表示する
2. 各商品の合計金額（価格×在庫数）を計算し、合計金額の大きい順に表示する
3. 在庫の状況を「在庫なし」「残りわずか（10個未満）」「在庫あり」で表示する

**ヒント:**

* 計算式を直接 SELECT 句に書くことができます（例: `price * 1.1`）
* 条件付きの値を表示するには `CASE` 式を使います
* 計算結果は `AS` で適切な列名を付けると見やすくなります

\<details> \<summary>解答\</summary>

```sql
-- 1. 税込価格と税額
SELECT
    name AS 商品名,
    price AS 税抜価格,
    price * 1.1 AS 税込価格,
    price * 0.1 AS 消費税額
FROM products;

-- 2. 合計金額の計算
SELECT
    name AS 商品名,
    price AS 単価,
    stock AS 在庫数,
    price * stock AS 合計金額
FROM products
ORDER BY 合計金額 DESC;

-- 3. 在庫状況の表示
SELECT
    name AS 商品名,
    stock AS 在庫数,
    CASE
        WHEN stock = 0 THEN '在庫なし'
        WHEN stock < 10 THEN '残りわずか'
        ELSE '在庫あり'
    END AS 在庫状況
FROM products;
```

\</details>
